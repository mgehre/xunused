name: C/C++ CI

on:
  push:
  pull_request:

jobs:
  build:
    name: Build and run tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          # Install build tools, ninja (if used), and LLVM (provides FileCheck and llvm-lit)
          sudo apt-get install -y cmake build-essential ninja-build llvm

      - name: Set up llvm-lit
        run: |
          # Create llvm-lit symlink from the lit.py script in LLVM installation
          LIT_PATH=$(find /usr/lib/llvm-*/build/utils/lit/lit.py -print -quit 2>/dev/null || true)
          if [ -n "$LIT_PATH" ]; then
            sudo ln -sf "$LIT_PATH" /usr/local/bin/llvm-lit
          else
            echo "Warning: lit.py not found in LLVM installation"
          fi

      - name: Configure
        run: cmake -S . -B build -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build -- -j

      - name: Locate xunused binary and add to PATH
        run: |
          XUNUSED_PATH=$(find build -type f -name xunused -print -quit || true)
          if [ -z "$XUNUSED_PATH" ]; then
            echo "xunused binary not found"
            ls -R build || true
            exit 1
          fi
          echo "$(dirname "$XUNUSED_PATH")" >> $GITHUB_PATH

      - name: Show xunused version (sanity)
        run: |
          if ! command -v xunused >/dev/null 2>&1; then
            echo "xunused not in PATH"; exit 1
          fi
          xunused --version || true

      - name: Run llvm-lit tests
        # Use llvm-lit from the Ubuntu llvm package (do not install lit via pip)
        run: llvm-lit -v tests
